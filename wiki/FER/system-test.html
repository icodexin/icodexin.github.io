<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 5.4.2">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.5">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>FER：系统测试 - 小芯的博客</title>

  
    <meta name="description" content="训练我们的神经网络设置训练参数如下： 1234567#初始化参数num_classes &#x3D; 7width, height &#x3D; 48, 48num_epochs &#x3D; 300batch_size &#x3D; 128num_features &#x3D; 64rate_drop &#x3D; 0.1  进行训练： 1234567891011es &#x3D; EarlyStopping(monitor&#x3D;&#39;val_loss&#39;, patienc">
<meta property="og:type" content="website">
<meta property="og:title" content="系统测试">
<meta property="og:url" content="https://codexin.cn/wiki/FER/system-test">
<meta property="og:site_name" content="小芯的博客">
<meta property="og:description" content="训练我们的神经网络设置训练参数如下： 1234567#初始化参数num_classes &#x3D; 7width, height &#x3D; 48, 48num_epochs &#x3D; 300batch_size &#x3D; 128num_features &#x3D; 64rate_drop &#x3D; 0.1  进行训练： 1234567891011es &#x3D; EarlyStopping(monitor&#x3D;&#39;val_loss&#39;, patienc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Acc_Loss.svg">
<meta property="og:image" content="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Confusion_Matrix.svg">
<meta property="og:image" content="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Effect1.webp">
<meta property="og:image" content="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Effect2.webp">
<meta property="article:published_time" content="2023-03-19T13:11:22.202Z">
<meta property="article:modified_time" content="2023-03-19T13:11:22.202Z">
<meta property="article:author" content="爱编程的小芯">
<meta property="article:tag" content="博客,C++,人工智能,机器学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Acc_Loss.svg">
  
  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="小芯的博客" type="application/atom+xml">
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  
    <link rel="shortcut icon" href="/images/favicon-48x48.ico">
  

  

  


  
    
      <link rel="icon" type="image/x-png" href="/images/favicon-128x128.png" sizes="128x128">
    
      <link rel="apple-touch-icon" type="image/x-png" href="/images/favicon-180x180.png">
    
      <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
  
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='wiki'>
    

  




<div class="widgets"><widget class="widget-wrapper logo-wrap wiki"><div class="widget-body"><a style="filter: grayscale(100%)" class="wiki-home cap" href="/wiki"><svg aria-hidden="true" viewBox="0 0 16 16" width="1rem" height="1rem" fill="currentColor"><path fill-rule="evenodd" d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"></path></svg>所有项目</a><a class="title" href="/wiki/FER/"><div class="main" ff="title">FER</div><div class="sub normal cap">基于VGG的人脸表情识别系统</div><div class="sub hover cap" style="opacity:0"> Coded by CodeXin</div></a></div></widget>
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" data-filter="/wiki/FER/" placeholder="在 /wiki/FER/ 中搜索"><svg t="1670596976048" class="icon search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2676" width="200" height="200"><path d="M938.2 832.6L723.8 618.1c-2.5-2.5-5.3-4.4-7.9-6.4 36.2-55.6 57.3-121.8 57.3-193.1C773.3 222.8 614.6 64 418.7 64S64 222.8 64 418.6c0 195.9 158.8 354.6 354.6 354.6 71.3 0 137.5-21.2 193.2-57.4 2 2.7 3.9 5.4 6.3 7.8L832.5 938c14.6 14.6 33.7 21.9 52.8 21.9 19.1 0 38.2-7.3 52.8-21.8 29.2-29.1 29.2-76.4 0.1-105.5M418.7 661.3C284.9 661.3 176 552.4 176 418.6 176 284.9 284.9 176 418.7 176c133.8 0 242.6 108.9 242.6 242.7 0 133.7-108.9 242.6-242.6 242.6" p-id="2677"></path></svg></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>




<widget class="widget-wrapper toc multi" id="data-toc"><div class="widget-header cap dis-select"><span class="name">系统测试</span></div><div class="widget-body fs14"><div class="doc-tree"><a class="doc-tree-link" href="/wiki/FER/#start"><span class="toc-text">项目简介</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/FER/system-desin"><span class="toc-text">系统设计</span></a></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/FER/system-realize"><span class="toc-text">系统实现</span></a></div><div class="doc-tree active"><a class="doc-tree-link active" href="/wiki/FER/system-test"><span class="toc-text">系统测试</span></a><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E6%88%91%E4%BB%AC%E7%9A%84%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C"><span class="toc-text">训练我们的神经网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E8%AE%AD%E7%BB%83%E6%95%88%E6%9E%9C"><span class="toc-text">可视化训练效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C"><span class="toc-text">评估测试效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B7%B7%E6%B7%86%E7%9F%A9%E9%98%B5%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-text">使用混淆矩阵进行分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E4%BA%BA%E8%84%B8%E8%A1%A8%E6%83%85%E8%AF%86%E5%88%AB"><span class="toc-text">实时人脸表情识别</span></a></li></ol></div><div class="doc-tree"><a class="doc-tree-link" href="/wiki/FER/system-conclusion"><span class="toc-text">系统总结</span></a></div></div></widget>

<widget class="widget-wrapper related"><div class="widget-header cap theme dis-select"><span class="name">更多深度学习</span></div><div class="widget-body related-posts"><a class="item wiki" href="/wiki/FCS/"><span class="title">基于计算机视觉的人脸比对系统设计与实现</span><span class="excerpt">毕业设计</span></a></div></widget>
</div>


    </aside>
    <div class='l_main'>
      

      

  
  
<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" id="home" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki/">项目</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/FER/">FER</a></div><div id="post-meta">更新于&nbsp;<time datetime="2023-03-19T13:11:22.202Z">2023-03-19</time></div></div>

  <article class='md-text content wiki'>
  <h1 class="article-title"><span>系统测试</span></h1>
  <h3 id="训练我们的神经网络"><a href="#训练我们的神经网络" class="headerlink" title="训练我们的神经网络"></a>训练我们的神经网络</h3><p>设置训练参数如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化参数</span></span><br><span class="line">num_classes = <span class="number">7</span></span><br><span class="line">width, height = <span class="number">48</span>, <span class="number">48</span></span><br><span class="line">num_epochs = <span class="number">300</span></span><br><span class="line">batch_size = <span class="number">128</span></span><br><span class="line">num_features = <span class="number">64</span></span><br><span class="line">rate_drop = <span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<p>进行训练：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">es = EarlyStopping(monitor=<span class="string">'val_loss'</span>, patience=<span class="number">10</span>, mode=<span class="string">'min'</span>, restore_best_weights=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">reduce_lr = ReduceLROnPlateau(monitor=<span class="string">'val_accuracy'</span>, factor=<span class="number">0.75</span>, patience=<span class="number">5</span>, verbose=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">history = model.fit(data_generator.flow(train_X, train_Y, batch_size),</span><br><span class="line">                    <span class="comment"># steps_per_epoch=len(train_X) / batch_size,</span></span><br><span class="line">                    batch_size=batch_size,</span><br><span class="line">                    epochs=num_epochs,</span><br><span class="line">                    verbose=<span class="number">2</span>,</span><br><span class="line">                    callbacks=[es, reduce_lr],</span><br><span class="line">                    validation_data=(val_X, val_Y))</span><br></pre></td></tr></table></figure>

<p>注意到，在上述代码中，使用了两个策略监测我们的网络：</p>
<ol>
<li>过拟合监测，如果没有更小的验证损失，则网络停止训练</li>
<li>学习速率监测，如果没有更好的验证精度，则降低学习速率</li>
</ol>
<p>部分训练输出信息如下：</p>
<figure class="highlight plaintext"><figcaption><span>Output</span></figcaption><table><tr><td class="code"><pre><span class="line">2021-12-26 05:35:09.313687: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:185] None of the MLIR Optimization Passes are enabled (registered 2)</span><br><span class="line"></span><br><span class="line">Epoch 1/300</span><br><span class="line"></span><br><span class="line">2021-12-26 05:35:10.991111: I tensorflow/stream_executor/cuda/cuda_dnn.cc:369] Loaded cuDNN version 8005</span><br><span class="line"></span><br><span class="line">225/225 - 20s - loss: 2.0907 - accuracy: 0.2503 - val_loss: 1.9219 - val_accuracy: 0.2494</span><br><span class="line"></span><br><span class="line">Epoch 2/300</span><br><span class="line"></span><br><span class="line">225/225 - 12s - loss: 1.8205 - accuracy: 0.2714 - val_loss: 1.8866 - val_accuracy: 0.2611</span><br><span class="line"></span><br><span class="line">Epoch 3/300</span><br><span class="line"></span><br><span class="line">225/225 - 12s - loss: 1.6999 - accuracy: 0.3240 - val_loss: 1.8933 - val_accuracy: 0.3090</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">Epoch 00020: ReduceLROnPlateau reducing learning rate to 0.007499999832361937.</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">Epoch 00037: ReduceLROnPlateau reducing learning rate to 0.005624999874271452.</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">Epoch 00048: ReduceLROnPlateau reducing learning rate to 0.004218749818392098.</span><br><span class="line"></span><br><span class="line">Epoch 49/300</span><br><span class="line">225/225 - 13s - loss: 0.7174 - accuracy: 0.7382 - val_loss: 1.0229 - val_accuracy: 0.6559</span><br></pre></td></tr></table></figure>

<p>我们观察到，训练过程中存在3次学习速率调整，最终在第49次迭代时提前终止训练。</p>
<h3 id="可视化训练效果"><a href="#可视化训练效果" class="headerlink" title="可视化训练效果"></a>可视化训练效果</h3><div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Acc_Loss.svg" alt="精度曲线和损失曲线" fancybox="true"></div><div class="image-meta"><span class="image-caption center">精度曲线和损失曲线</span></div></div>

<p>代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line">%config InlineBackend.figure_format = <span class="string">'svg'</span></span><br><span class="line">fig, axes = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">18</span>, <span class="number">6</span>))</span><br><span class="line"><span class="comment"># 绘制训练和验证精度曲线</span></span><br><span class="line">axes[<span class="number">0</span>].plot(history.history[<span class="string">'accuracy'</span>])</span><br><span class="line">axes[<span class="number">0</span>].plot(history.history[<span class="string">'val_accuracy'</span>])</span><br><span class="line">axes[<span class="number">0</span>].set_title(<span class="string">'Model accuracy'</span>)</span><br><span class="line">axes[<span class="number">0</span>].set_ylabel(<span class="string">'Accuracy'</span>)</span><br><span class="line">axes[<span class="number">0</span>].set_xlabel(<span class="string">'Epoch'</span>)</span><br><span class="line">axes[<span class="number">0</span>].legend([<span class="string">'Train'</span>, <span class="string">'Validation'</span>], loc=<span class="string">'upper left'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制训练和验证损失曲线</span></span><br><span class="line">axes[<span class="number">1</span>].plot(history.history[<span class="string">'loss'</span>])</span><br><span class="line">axes[<span class="number">1</span>].plot(history.history[<span class="string">'val_loss'</span>])</span><br><span class="line">axes[<span class="number">1</span>].set_title(<span class="string">'Model loss'</span>)</span><br><span class="line">axes[<span class="number">1</span>].set_ylabel(<span class="string">'Loss'</span>)</span><br><span class="line">axes[<span class="number">1</span>].set_xlabel(<span class="string">'Epoch'</span>)</span><br><span class="line">axes[<span class="number">1</span>].legend([<span class="string">'Train'</span>, <span class="string">'Validation'</span>], loc=<span class="string">'upper left'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>通过观察曲线，我们可以得知神经网络后期存在轻微的过拟合现象。</p>
<h3 id="评估测试效果"><a href="#评估测试效果" class="headerlink" title="评估测试效果"></a>评估测试效果</h3><p>我们对测试数据集，进行评估分析，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test_true = np.argmax(test_Y, axis=<span class="number">1</span>)</span><br><span class="line">test_pred = np.argmax(model.predict(test_X), axis=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"CNN Model Accuracy on test set: {:.4f}"</span>.<span class="built_in">format</span>(accuracy_score(test_true, test_pred)))</span><br></pre></td></tr></table></figure>

<p>输出信息如下：</p>
<figure class="highlight plaintext"><figcaption><span>Output</span></figcaption><table><tr><td class="code"><pre><span class="line">CNN Model Accuracy on test set: 0.6704</span><br></pre></td></tr></table></figure>

<p>最终，我们的VGGNet网络，对各个数据集的准确率，如下表所示。</p>
<table>
<thead>
<tr>
<th></th>
<th>Accuracy</th>
</tr>
</thead>
<tbody><tr>
<td>Train</td>
<td>73.28%</td>
</tr>
<tr>
<td>Validation</td>
<td>65.59%</td>
</tr>
<tr>
<td>Test</td>
<td>67.04%</td>
</tr>
</tbody></table>
<h3 id="使用混淆矩阵进行分析"><a href="#使用混淆矩阵进行分析" class="headerlink" title="使用混淆矩阵进行分析"></a>使用混淆矩阵进行分析</h3><p>绘制混淆矩阵，以分析表情之间是否会相互混淆，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">fusion_matrix(y_true, y_pred, classes,</span><br><span class="line">                          normalize=<span class="literal">False</span>,</span><br><span class="line">                          title=<span class="literal">None</span>,</span><br><span class="line">                          cmap=plt.cm.Blues):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    此函数打印和绘制混淆矩阵</span></span><br><span class="line"><span class="string">    可以通过设置“normalize=True”来应用规范化。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> title:</span><br><span class="line">        <span class="keyword">if</span> normalize:</span><br><span class="line">            title = <span class="string">'Normalized confusion matrix'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            title = <span class="string">'Confusion matrix, without normalization'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算混淆矩阵</span></span><br><span class="line">    cm = confusion_matrix(y_true, y_pred)</span><br><span class="line">    <span class="comment"># 仅使用数据中显示的标签</span></span><br><span class="line">    classes = classes</span><br><span class="line">    <span class="keyword">if</span> normalize:</span><br><span class="line">        cm = cm.astype(<span class="string">'float'</span>) / cm.<span class="built_in">sum</span>(axis=<span class="number">1</span>)[:, np.newaxis]</span><br><span class="line">        <span class="comment">#print("Normalized confusion matrix")</span></span><br><span class="line">    <span class="comment">#else:</span></span><br><span class="line">    <span class="comment">#print('Confusion matrix, without normalization')</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(cm)</span></span><br><span class="line"></span><br><span class="line">    fig, ax = plt.subplots(figsize=(<span class="number">12</span>, <span class="number">6</span>))</span><br><span class="line">    im = ax.imshow(cm, interpolation=<span class="string">'nearest'</span>, cmap=cmap)</span><br><span class="line">    ax.figure.colorbar(im, ax=ax)</span><br><span class="line">    <span class="comment"># 显示所有的标记...</span></span><br><span class="line">    ax.<span class="built_in">set</span>(xticks=np.arange(cm.shape[<span class="number">1</span>]),</span><br><span class="line">           yticks=np.arange(cm.shape[<span class="number">0</span>]),</span><br><span class="line">           <span class="comment"># ... 用相应的列表条目标记它们</span></span><br><span class="line">           xticklabels=classes, yticklabels=classes,</span><br><span class="line">           title=title,</span><br><span class="line">           ylabel=<span class="string">'True label'</span>,</span><br><span class="line">           xlabel=<span class="string">'Predicted label'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 旋转x轴标签并设置其对齐方式。</span></span><br><span class="line">    plt.setp(ax.get_xticklabels(), rotation=<span class="number">45</span>, ha=<span class="string">"right"</span>,</span><br><span class="line">             rotation_mode=<span class="string">"anchor"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在数据维度上循环并创建文本批注</span></span><br><span class="line">    fmt = <span class="string">'.2f'</span> <span class="keyword">if</span> normalize <span class="keyword">else</span> <span class="string">'d'</span></span><br><span class="line">    thresh = cm.<span class="built_in">max</span>() / <span class="number">2.</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cm.shape[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(cm.shape[<span class="number">1</span>]):</span><br><span class="line">            ax.text(j, i, <span class="built_in">format</span>(cm[i, j], fmt),</span><br><span class="line">                    ha=<span class="string">"center"</span>, va=<span class="string">"center"</span>,</span><br><span class="line">                    color=<span class="string">"white"</span> <span class="keyword">if</span> cm[i, j] &gt; thresh <span class="keyword">else</span> <span class="string">"black"</span>)</span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    <span class="keyword">return</span> ax</span><br><span class="line"></span><br><span class="line"><span class="comment"># %%</span></span><br><span class="line"><span class="comment"># 绘制归一化混淆矩阵</span></span><br><span class="line">%matplotlib inline</span><br><span class="line">%config InlineBackend.figure_format = <span class="string">'svg'</span></span><br><span class="line">plot_confusion_matrix(test_true, test_pred, classes=emotion_labels, normalize=<span class="literal">True</span>, title=<span class="string">'Normalized confusion matrix'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>输出的混淆矩阵如下图所示。通过分析混淆矩阵，可知：Disgust比较容易和其他表情混淆，这是由于Disgust的样本数本身就很少。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Confusion_Matrix.svg" alt="混淆矩阵"></p>
<h3 id="实时人脸表情识别"><a href="#实时人脸表情识别" class="headerlink" title="实时人脸表情识别"></a>实时人脸表情识别</h3><p>将已经训练好的模型存入本地，使用摄像头实时捕捉人脸，并识别出相应的表情。我们的思路是，从捕获的图像中，先使用人脸检测器，检测出人脸区域，然后将该区域实施灰度化，并将图片大小缩放至<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="7.291ex" height="1.581ex" role="img" focusable="false" viewBox="0 -677 3222.4 699"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(1222.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mn" transform="translate(2222.4,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g></svg></mjx-container>，最后送入我们的模型，进行预测，得到相应的表情输出。相应的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2 <span class="keyword">as</span> cv</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">model = models.load_model(<span class="string">'./FER_Model.h5'</span>)</span><br><span class="line"></span><br><span class="line">emotion_map = {<span class="number">0</span>: <span class="string">'Angry'</span>, <span class="number">1</span>: <span class="string">'Disgust'</span>, <span class="number">2</span>: <span class="string">'Fear'</span>, <span class="number">3</span>: <span class="string">'Happy'</span>, <span class="number">4</span>: <span class="string">'Sad'</span>, <span class="number">5</span>: <span class="string">'Surprise'</span>, <span class="number">6</span>: <span class="string">'Neutral'</span>}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cap = cv.VideoCapture(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Can not open camera!"</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># 逐帧捕获</span></span><br><span class="line">    ret, frame = cap.read()</span><br><span class="line">    <span class="comment"># 转换成灰度图像</span></span><br><span class="line">    gray = cv.cvtColor(frame, cv.COLOR_BGR2GRAY)</span><br><span class="line">    classifier = cv.CascadeClassifier(<span class="string">"./haarcascade_frontalface_default.xml"</span>)</span><br><span class="line">    faceRects = classifier.detectMultiScale(gray, scaleFactor=<span class="number">1.2</span>, minNeighbors=<span class="number">3</span>, minSize=(<span class="number">32</span>, <span class="number">32</span>))</span><br><span class="line">    color = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(faceRects):  <span class="comment"># 大于0则检测到人脸</span></span><br><span class="line">        <span class="keyword">for</span> faceRect <span class="keyword">in</span> faceRects:  <span class="comment"># 单独框出每一张人脸</span></span><br><span class="line">            x, y, w, h = faceRect</span><br><span class="line">            <span class="comment"># 框出人脸</span></span><br><span class="line">            cv.rectangle(frame, (x, y), (x + h, y + w), color, <span class="number">2</span>)</span><br><span class="line">            <span class="comment"># 获取人脸源</span></span><br><span class="line">            src = gray[y:y + w, x:x + h]</span><br><span class="line">            <span class="comment"># 缩放至48*48</span></span><br><span class="line">            img = cv.resize(src, (<span class="number">48</span>, <span class="number">48</span>))</span><br><span class="line">            <span class="comment"># 归一化</span></span><br><span class="line">            img = img / <span class="number">255.</span></span><br><span class="line">            <span class="comment"># 扩展维度</span></span><br><span class="line">            x = np.expand_dims(img, axis=<span class="number">0</span>)</span><br><span class="line">            x = np.array(x, dtype=<span class="string">'float32'</span>).reshape(-<span class="number">1</span>, <span class="number">48</span>, <span class="number">48</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="comment"># 预测输出</span></span><br><span class="line">            y = model.predict(x)</span><br><span class="line">            output_class = np.argmax(y[<span class="number">0</span>])</span><br><span class="line">            cv.putText(frame, emotion_map[output_class], (<span class="number">200</span>, <span class="number">100</span>), cv.FONT_HERSHEY_COMPLEX,</span><br><span class="line">                       <span class="number">2.0</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">250</span>), <span class="number">5</span>)</span><br><span class="line">    cv.imshow(<span class="string">"frame"</span>, frame)</span><br><span class="line">    <span class="keyword">if</span> cv.waitKey(<span class="number">1</span>) == <span class="built_in">ord</span>(<span class="string">'q'</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">cap.release()</span><br><span class="line">cv.destroyAllWindows()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述代码中，haarcascade_frontalface_default.xml是由OpenCV提供的人脸检测器。</p>
<p>识别效果样例如下图所示。</p>
<div class="tag-plugin gallery swiper" id="swiper-api" width="max"><div class="swiper-wrapper"><div class="swiper-slide"><img class="lazy" no-lazy="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Effect1.webp"></div><div class="swiper-slide"><img class="lazy" no-lazy="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://blog-1302549712.cos.ap-nanjing.myqcloud.com/image/wiki/FER/Effect2.webp"></div></div><div class="swiper-pagination"></div><div class="swiper-button-prev blur"></div><div class="swiper-button-next blur"></div></div>
  


  </article>
  
<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">回顾上一篇</div><a href="/wiki/FER/system-realize">系统实现</a></div><div class="item" id="next"><div class="note">接下来阅读</div><a href="/wiki/FER/system-conclusion">系统总结</a></div></section></div>

  

  <div class='related-wrap md-text reveal' id="comments">
    <section class='header cmt-title cap theme'>
      快来参与讨论吧
    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>




      
<footer class="page-footer reveal fs12"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs14">博客</span><a href="/">近期</a><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a></div><div class="sitemap-group"><span class="fs14">项目</span><a href="/wiki/">开源库</a></div><div class="sitemap-group"><span class="fs14">社交</span><a href="/friends/">友链</a><a href="/about/#comments">留言板</a></div><div class="sitemap-group"><span class="fs14">更多</span><a href="/about/">关于本站</a><a href="/privacy/">隐私政策</a><a href="/timeline/">博主动态</a><a target="_blank" rel="noopener" href="https://github.com/icodexin">GitHub</a></div></div><div class="text"><p>本站由 <a target="_blank" rel="noopener" href="https://github.com/icodexin">@爱编程的小芯</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。<br>本站总访问量<span id="busuanzi_value_site_pv"></span>次，访客数<span id="busuanzi_value_site_uv"></span>人次</p>
<hr>
<p>Copyright © 2023 <a href="https://codexin.cn/">codexin.cn</a>. 保留所有权利。<br><a href="https://icp.gov.moe/?keyword=20238666" target="_blank">萌ICP备20238666号</a></p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.18.5';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.5';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function load_comment(){
    if(!document.getElementById("waline_container"))return;
    stellar.loadCSS('https://unpkg.com/@waline/client@2.14.1/dist/waline.css');
    stellar.loadScript('https://unpkg.com/@waline/client@2.14.1/dist/waline.js', {defer:true}).then(function () {
      const el = document.getElementById("waline_container");
      var path = el.getAttribute('comment_id');
      if (!path) {
        path = decodeURI(window.location.pathname);
      }
      Waline.init(Object.assign({"js":"https://unpkg.com/@waline/client@2.14.1/dist/waline.js","css":"https://unpkg.com/@waline/client@2.14.1/dist/waline.css","serverURL":"https://comment.codexin.cn","commentCount":true,"pageview":false,"emoji":["https://unpkg.com/@waline/emojis@1.1.0/weibo","https://unpkg.com/@waline/emojis@1.1.0/alus","https://unpkg.com/@waline/emojis@1.1.0/bilibili","https://unpkg.com/@waline/emojis@1.1.0/qq","https://unpkg.com/@waline/emojis@1.1.0/tieba","https://unpkg.com/@waline/emojis@1.1.0/tw-emoji","https://unpkg.com/@waline/emojis@1.1.0/bmoji"],"reaction":["https://unpkg.com/@waline/emojis@1.1.0/bmoji/bmoji_thumb_up.png","https://unpkg.com/@waline/emojis@1.1.0/bmoji/bmoji_abandon.png","https://unpkg.com/@waline/emojis@1.1.0/bmoji/bmoji_unavailble_doge.png","https://unpkg.com/@waline/emojis@1.1.0/bmoji/bmoji_what.png"],"locale":{"placeholder":"欢迎友善的评论哦！","reaction0":"真不错","reaction1":"一般般","reaction2":"好神奇啊","reaction3":"我不理解"}}, {
        el: '#waline_container',
        path: path,
      }));
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
    console.log('DOM fully loaded and parsed');
    load_comment();
  });

</script>




<!-- inject -->


  </div>
</body>
</html>
